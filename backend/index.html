<html>
<head>
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-core.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-sankey.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-cartesian.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-data-adapter.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src = "./data.js"></script>
<script src = "./title.js"></script>
<script src = "./colors.js"></script>
<script src = "./hovored_colors.js"></script>

</head>
<body>
<div id="container" style="width: 100%; height: 250%;"></div>
<script>


var data, colors_data;

anychart.onDocumentReady(function () {
    

    // //Title
    // var client1 = new XMLHttpRequest();
    // client1.open('GET', '/title.txt',false);
    // client1.onreadystatechange = function() 
    // {
    //     response = client1.responseText
    //     title = response      
    // }
    // client1.send();

    // var client2 = new XMLHttpRequest();
    // client2.open('GET', '/colors.json',false);
    // client2.onreadystatechange = function() 
    // {
    //     response = client2.responseText
    //     colors_data = JSON.parse(response)
    // }
    // client2.send();

    // var client3 = new XMLHttpRequest();
    // client3.open('GET', '/hovored_colors.json',false);
    // client3.onreadystatechange = function() 
    // {
    //     response = client3.responseText
    //     hovered_colors_data = JSON.parse(response)
    // }
    // client3.send();
    
    
        
    // create a chart and set the data
    var chart = anychart.sankey(sankeydata);

    chart.node().fill(function() {
        var customColor = colors[this.name];
        if (customColor) return customColor;
        return this.sourceColor;
    });

    chart.node().hovered().fill(function() {
        var customColor = hovored_colors[this.name];
        if (customColor) return customColor;
        return this.sourceColor;
    });


    // // replace 'Sector' and  'Subsector' strings
    const mapObj = {
    Sector: "",
    Subsector: ""
    };
    
    chart.node().labels().useHtml(true).format(function() {
        return "<span style='font-weight:bold'>" + this.name.replace(/\b(?:Sector|Subsector)\b/gi, matched => mapObj[matched]) + "</span><br>" + this.value.toPrecision(2) + " - GtCO2e"  
    })

        
       
    chart.node().tooltip().format(function() {
        var incomeText = "";
        var sum = 0;

        for (i = 0; i < this.income.length; i++) {
        sum +=  this.income[i].value ;
        }
        for (i = 0; i < this.income.length; i++) {
        incomeText += this.income[i].name.replace(/\b(?:Sector|Subsector)\b/gi, matched => mapObj[matched]) + ": " + Math.round((this.income[i].value/sum*100 + Number.EPSILON) * 100)/100 +" %\n"
        }
        return incomeText;
    });
    
    var tooltip = chart.tooltip();
    tooltip.fontSize(13);
    tooltip.fontFamily("Calibri");
    tooltip.fontStyle("italic");
    // tooltip.titleFormat("{%name} - {%value} GtCO2e");

    chart.nodeWidth("80%");
    chart.nodePadding(40);
    chart.palette(['#D0D0D0']);
    chart.title("\n"+title+"\n");
    chart.container("container");
    chart.draw();
    
});

</script>
</body>
</html>
